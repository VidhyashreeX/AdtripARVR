<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Virtual Try-On</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #000;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 100;
            text-align: center;
            font-size: 14px;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
            max-width: 90%;
        }

        .controls h2 {
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        .dress-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .dress-btn {
            padding: 12px 24px;
            border: 2px solid #333;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .dress-btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        .dress-btn.active {
            background: #333;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            background: #4CAF50;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .action-btn:hover {
            background: #45a049;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 50px;
            border-radius: 10px;
            z-index: 200;
            text-align: center;
        }

        #loading.hidden {
            display: none;
        }

        #status {
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #4CAF50;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <div class="instructions">
        üìè Stand 3-4 feet from camera | üëï Show upper body | üí° Good lighting
    </div>

    <div id="status">üü¢ Tracking Active</div>

    <div class="controls">
        <h2>Select Your Outfit</h2>
        <div class="dress-buttons">
            <button class="dress-btn active" data-dress="1">Dress 1</button>
            <button class="dress-btn" data-dress="2">Dress 2</button>
            <button class="dress-btn" data-dress="3">Dress 3</button>
            <button class="dress-btn" data-dress="4">Dress 4</button>
        </div>
        <div class="action-buttons">
            <button class="action-btn" id="capture-btn">üì∏ Capture Photo</button>
            <button class="action-btn" id="download-btn" style="background: #2196F3;">üíæ Download</button>
        </div>
    </div>

    <div id="loading">
        <p>Loading AR System...</p>
        <p style="font-size: 12px; margin-top: 10px;">Initializing pose detection</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');

        let currentDress = 1;
        const dressImages = {};
        let poseResults = null;
        let capturedImage = null;

        // Preload dress images
        function preloadDresses() {
            for (let i = 1; i <= 4; i++) {
                const img = new Image();
                img.src = `assets/dress${i}.png`;
                img.crossOrigin = 'anonymous';
                dressImages[i] = img;
            }
        }

        // Initialize MediaPipe Pose
        const pose = new Pose({
            locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
            }
        });

        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            enableSegmentation: false,
            smoothSegmentation: false,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onPoseResults);

        // Handle pose detection results
        function onPoseResults(results) {
            poseResults = results;
            status.style.color = results.poseLandmarks ? '#4CAF50' : '#ff9800';
            status.textContent = results.poseLandmarks ? 'üü¢ Body Detected' : 'üü° Searching...';
        }

        // Start camera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // Start pose detection
                    const camera = new Camera(video, {
                        onFrame: async () => {
                            await pose.send({ image: video });
                        },
                        width: 1280,
                        height: 720
                    });
                    camera.start();

                    loading.classList.add('hidden');
                    drawFrame();
                };
            } catch (error) {
                loading.innerHTML = `<p style="color: red;">Camera Error: ${error.message}</p>`;
            }
        }

        // Draw frame with AR overlay
        function drawFrame() {
            // Draw video
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();

            // Draw dress if pose detected
            if (poseResults && poseResults.poseLandmarks) {
                drawDressOnBody(poseResults.poseLandmarks);
            }

            requestAnimationFrame(drawFrame);
        }

        // Draw dress aligned to body landmarks
        function drawDressOnBody(landmarks) {
            const dress = dressImages[currentDress];
            if (!dress.complete) return;

            // Get key body landmarks
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];

            if (!leftShoulder || !rightShoulder || !leftHip || !rightHip) return;

            // Calculate dress position and size based on body
            const shoulderMidX = ((leftShoulder.x + rightShoulder.x) / 2) * canvas.width;
            const shoulderMidY = ((leftShoulder.y + rightShoulder.y) / 2) * canvas.height;
            
            const shoulderWidth = Math.abs(leftShoulder.x - rightShoulder.x) * canvas.width;
            const bodyHeight = Math.abs(leftShoulder.y - leftHip.y) * canvas.height;

            // Dress dimensions
            const dressWidth = shoulderWidth * 2.5;
            const aspectRatio = dress.height / dress.width;
            const dressHeight = dressWidth * aspectRatio;

            // Draw dress centered on body
            const x = shoulderMidX - (dressWidth / 2);
            const y = shoulderMidY - (dressHeight * 0.15);

            ctx.save();
            ctx.globalAlpha = 0.9;
            ctx.drawImage(dress, x, y, dressWidth, dressHeight);
            ctx.restore();
        }

        // Capture photo
        document.getElementById('capture-btn').addEventListener('click', () => {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCtx.drawImage(canvas, 0, 0);
            capturedImage = tempCanvas.toDataURL('image/png');
            
            alert('‚úÖ Photo captured! Click Download to save.');
        });

        // Download photo
        document.getElementById('download-btn').addEventListener('click', () => {
            if (!capturedImage) {
                alert('‚ö†Ô∏è Please capture a photo first!');
                return;
            }

            const link = document.createElement('a');
            link.download = `ar-tryon-${Date.now()}.png`;
            link.href = capturedImage;
            link.click();
        });

        // Dress selection
        document.querySelectorAll('.dress-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentDress = parseInt(btn.getAttribute('data-dress'));
                document.querySelectorAll('.dress-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Initialize
        preloadDresses();
        startCamera();
    </script>
</body>
</html>
